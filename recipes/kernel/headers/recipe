# Build recipe for linux (libre) headers.
#
# Copyright (C) 2015-2017 Matias A. Fonzo, selk@dragora.org.
#
# This recipe is free software: you have unlimited permission
# to copy, distribute and modify it.

program=linux
version=4.9.46
release=1

pkgname=kernel-headers
tarname=${program}-libre-${version}-gnu.tar.lz

# Remote source(s)
fetch=http://linux-libre.fsfla.org/pub/linux-libre/releases/${version}-gnu/$tarname

description="
The Linux kernel headers.

The Linux kernel headers from the GNU Linux-libre project.
"

homepage=http://www.gnu.org/software/linux-libre
license=GPLv2+

build()
{
    set -e

    unpack "${tardir}/$tarname"

    cd "$srcdir"

    # Expose headers from some extra patches

    # AUFS
    cp -R -p "${worktree}/patches/kernel/aufs/fs" .

    mkdir -p include/uapi/linux
    cp -p "${worktree}"/patches/kernel/aufs/include/uapi/linux/*.h \
          include/uapi/linux/

    # http://github.com/sfjro/aufs4-standalone/tree/aufs4.9
    patch -p1 < "${worktree}/patches/kernel/aufs/aufs4-kbuild.patch"
    patch -p1 < "${worktree}/patches/kernel/aufs/aufs4-base.patch"
    patch -p1 < "${worktree}/patches/kernel/aufs/aufs4-mmap.patch"
    patch -p1 < "${worktree}/patches/kernel/aufs/aufs4-standalone.patch"

    make mrproper
    make headers_check
    make INSTALL_HDR_PATH="${destdir}/usr" headers_install

    # Remove cruft
    find "${destdir}/usr/include" \
      -type f \( -name .install -o -name ..install.cmd \) -exec rm -f {} +
}

