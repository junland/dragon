#
# Build recipe for binutils.
#
# Copyright (C) 2015-2017 Matias A. Fonzo, selk@dragora.org.
#
# This recipe is free software: you have unlimited permission
# to copy, distribute and modify it.

program=binutils
version=2.29.1
release=1

tarname=${program}-${version}.tar.lz

# Remote source(s)
fetch=http://ftp.gnu.org/gnu/binutils/$tarname

description="
The GNU binary utilities.

Binutils is a collection of programming tools for the manipulation
of object code in various object file formats.  These tools consist
of the GNU linker (ld), the GNU assembler (as) and the profiler
(gprof).  There is also a collection of other binary tools like
the disassembler (objdump).
"

homepage=http://www.gnu.org/software/binutils
license="GPLv2+, GPLv3+, LGPLv2, LGPLv3"

# Source documentation
docs="COPYING* README"
docsdir="${docdir}/${program}-${version}"

# System-dependent
MACHTYPE="$(cc -dumpmachine)"

build()
{
    set -e

    unpack "${tardir}/$tarname"

    cd "$srcdir"

    # Create a separate build directory
    rm -rf ../binutils-build
    mkdir ../binutils-build
    cd ../binutils-build

    ../${program}-${version}/configure \
    CFLAGS="$QICFLAGS" CXXFLAGS="$QICXXFLAGS" LDFLAGS="$QILDFLAGS" \
     $configure_args \
     $multilib_options \
     --libdir=/usr/lib${libSuffix} \
     --mandir=$mandir \
     --infodir=$infodir \
     --with-docdir=$docsdir \
     --enable-deterministic-archives \
     --enable-shared \
     --enable-lto \
     --enable-nls \
     --enable-plugins \
     --enable-threads \
     --enable-targets=$MACHTYPE \
     --disable-werror \
     --disable-compressed-debug-sections \
     --build=$MACHTYPE

    make -j${jobs} tooldir=/usr/${MACHTYPE}
    make -k check
    make -j${jobs} tooldir=/usr/${MACHTYPE} DESTDIR="$destdir" install

    # Back to srcdir
    cd .. && cd "$srcdir"

    # Replace hard-links with relative soft-links for the package size
    (
        cd "${destdir}/usr/bin" && \
        rm -f ld ; ln -sf ld.bfd ld
    )
    (
        cd "${destdir}/usr/${MACHTYPE}/bin" && \
        for file in *
        do
            if test -x "../../bin/$file"
            then
                rm -f "$file" && ln -s "../../bin/$file" .
            fi
        done
    )

    # Compress info documents deleting index file for the package
    if test -d "${destdir}/$infodir"
    then
        rm -f "${destdir}/${infodir}/dir"
        lzip -9 "${destdir}/${infodir}"/*
    fi

    # Compress man pages
    if test -d "${destdir}/$mandir"
    then
        lzip -9 "${destdir}/${mandir}"/man?/*
    fi

    # Copy documentation
    mkdir -p "${destdir}${docsdir}"
    cp -p $docs "${destdir}${docsdir}/"

    # Delete temporary build directory
    cd -- "$TMPDIR"
    if test -d ./binutils-build
    then
        rm -rf ./binutils-build
    fi
}

