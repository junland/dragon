# Build recipe for tar.
#
# Copyright (c) 2016-2017 Matias Fonzo, <selk@dragora.org>.
# Copyright (c) 2019 Matias Fonzo, <selk@dragora.org>.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

program=tar
version=1.31
release=2

# Set 'outdir' for a nice and well-organized output directory
outdir="${outdir}/${arch}/tools"

tarname=${program}-${version}.tar.bz2

# Remote source(s)
fetch=http://ftp.gnu.org/gnu/tar/$tarname

description="
Tool to package and manipulate files.

The tar program provides the ability to create tar archives, as well as
various other kinds of manipulation.  For example, you can use tar on
previously created archives to extract files, to store additional
files, or to update or list files which were already stored.

The name of tar comes from \"Tape ARchiver\".
"

homepage=http://www.gnu.org/software/tar
license=GPLv3+

# Source documentation
docs="AUTHORS COPYING ChangeLog NEWS README THANKS TODO"
docsdir="${docdir}/${program}-${version}"

# Limit package name to the program name
full_pkgname=$program

build()
{
    set -e

    unpack "${tardir}/$tarname"

    cd "$srcdir"

    # Set sane permissions
    chmod -R u+w,go-w,a+rX-s .

    # A regression for tar 1.31+:
    # http://git.savannah.nongnu.org/cgit/tar.git/commit/?id=85c005ee1345c342f707f3c55317daf6cb050603
    patch -p1 < "${worktree}/patches/tar/85c005ee1345c342f707f3c55317daf6cb050603"

    ./configure CFLAGS="$QICFLAGS" LDFLAGS="$QILDFLAGS -static" \
    FORCE_UNSAFE_CONFIGURE="1" \
     $configure_args \
     --libdir=/usr/lib${libSuffix} \
     --infodir=$infodir \
     --mandir=$mandir \
     --docdir=$docsdir \
     --enable-backup-scripts \
     --enable-nls \
     --build="$(cc -dumpmachine)"

    make -j${jobs} V=1
    make -j${jobs} DESTDIR="$destdir" install

    # Remove generated charset.alias
    rm -f "${destdir}/usr/lib${libSuffix}/charset.alias"
    rmdir "${destdir}/usr/lib${libSuffix}" || true

    # Compress info documents deleting index file for the package
    if test -d "${destdir}/$infodir"
    then
        rm -f "${destdir}/${infodir}/dir"
        lzip -9 "${destdir}/${infodir}"/*
    fi

    # Compress and link man pages (if needed)
    if test -d "${destdir}/$mandir"
    then
        (
            cd "${destdir}/$mandir"
            find . -type f -exec lzip -9 '{}' +
            find . -type l | while read -r file
            do
                ln -sf "$(readlink -- "$file").lz" "${file}.lz"
                rm -- "$file"
            done
        )
    fi

    # Copy documentation
    mkdir -p "${destdir}${docsdir}"
    cp -p $docs "${destdir}${docsdir}"
}

