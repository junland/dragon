# Build recipe for dcron.
#
# Copyright (C) 2017 Alan Beadle, ab.beadle@gmail.com.
#
# This recipe is free software: you have unlimited permission
# to copy, distribute and modify it.

program=dcron
version=4.5
release=1

tarname=${program}-${version}.tar.gz

# Remote source(s)
fetch=http://www.jimpryor.net/linux/releases/$tarname

description="
A minimalist cron daemon.

This lightweight cron daemon aims to be simple and secure, with just
enough features to stay useful.  It was written from scratch by
Matt Dillon in 1994.  Now developed and maintained by Jim Pryor.
"

homepage=http://www.jimpryor.net/linux/dcron.html
license="GPL, any version"

# Source documentation
docs="CHANGELOG CHANGELOG.working README"
docsdir="${docdir}/${program}-${version}"

build()
{
    set -e

    unpack "${tardir}/$tarname"

    cd "$srcdir"


    make -j${jobs} CFLAGS="$QICFLAGS" LDFLAGS="$QILDFLAGS -static" \
                   PREFIX=/usr CRONTAB_GROUP=users
    make -j${jobs} DESTDIR="$destdir" install

    mkdir -p "${destdir}/var/spool/cron/crontabs"
    cp extra/root.crontab "${destdir}/var/spool/cron/crontabs/root"
    chmod 600 "${destdir}/var/spool/cron/crontabs/root"

    cp extra/run-cron "${destdir}/usr/sbin/run-cron"
    chmod 755 "${destdir}/usr/sbin/run-cron"

    # Deprecated in favor of tinylog(8) and socklog.
    #mkdir -p "${destdir}/etc/logrotate.d/"
    #cp -p extra/crond.logrotate "${destdir}/etc/logrotate.d/crond"
    #chmod 644 "${destdir}/etc/logrotate.d/crond"

    mkdir -p "${destdir}/etc/cron.hourly"  \
             "${destdir}/etc/cron.daily"   \
             "${destdir}/etc/cron.weekly"  \
             "${destdir}/etc/cron.monthly"

    # Compress man pages
    lzip -9 "${destdir}/${mandir}"/man?/*

    # Copy documentation
    mkdir -p "${destdir}${docsdir}"

    for file in $docs
    do
        cp -p $file "${destdir}${docsdir}"
    done
}

