# Build recipe for libffi.
#
# Copyright (C) 2017 Matias A. Fonzo, selk@dragora.org.
#
# This recipe is free software: you have unlimited permission
# to copy, distribute and modify it.

program=libffi
version=3.2.1
release=1

description="
A high level programming interface to various calling conventions.

The libffi library provides a portable, high level programming
interface to various calling conventions.  This allows a programmer to
call any function specified by a call interface description at run time.
"

homepage=http://sourceware.org/libffi/
license=BSD

tarname=${program}-${version}.tar.gz

# Remote source(s)
fetch=ftp://sourceware.org/pub/libffi/$tarname

# Parallel jobs for the compiler
jobs=1

# Source documentation
docs="ChangeLog LICENSE README"
docsdir="${docdir}/${program}-${version}"

build() {
    set -e

    unpack "${tardir}/$tarname"

    cd "$srcdir"

    # Sanitize the header installation path
    patch -p0 < "${worktree}/patches/libffi/libffi-paths.patch"

    ./configure CFLAGS="$QICFLAGS" LDFLAGS="$QILDFLAGS" \
    $configure_args \
    --libdir=/usr/lib${libSuffix} \
    --infodir=$infodir \
    --mandir=$mandir \
    --docdir=$docsdir \
    --build="$(cc -dumpmachine)"

    make -j${jobs} V=1
    make -j${jobs} DESTDIR="$destdir" install-strip

    # Compress info documents deleting index file for the package
    if test -d "${destdir}/$infodir"
    then
        rm -f "${destdir}/${infodir}/dir"
        lzip -9 "${destdir}/${infodir}"/*
    fi

    # Compress manual pages
    if [ -d "${destdir}/$mandir" ] ; then
	(
            cd "${destdir}/$mandir"
	    find . -type f -exec lzip -9 '{}' +
	    find . -type l | while read -r file
	    do
		ln -sf "$(readlink -- "$file").lz" "${file}.lz"
		rm -- "$file"
	    done
	)
    fi

    # Copy documentation
    mkdir -p "${destdir}${docsdir}"
    cp -p $docs "${destdir}${docsdir}/"
}

