# Build recipe for musl.
#
# Copyright (C) 2015-2017 Matias A. Fonzo, selk@dragora.org.
#
# This recipe is free software: you have unlimited permission
# to copy, distribute and modify it.

program=musl
version=1.1.17
release=1

tarname=${program}-${version}.tar.gz

# Remote source(s)
fetch=http://www.musl-libc.org/releases/$tarname

description="
A powerful standard C/POSIX library.

Musl is a new standard library to power a new generation of Linux-based
devices.  Musl is lightweight, fast, simple, free, and strives to be
correct in the sense of standards-conformance and safety.
"

homepage=http://www.musl-libc.org
license=MIT

# Source documentation
docs="COPYRIGHT README VERSION WHATSNEW"
docsdir="${docdir}/${pkgname}-${version}"

build()
{
    set -e

    unpack "${tardir}/$tarname"

    cd "$srcdir"

    patch -Np0 -i "${worktree}/patches/musl/musl-utmp_path.diff"

    ./configure $configure_args \
     --libdir=/usr/lib${libSuffix} \
     --syslibdir=/lib \
     --enable-shared \
     --enable-static \
     --enable-optimize=size

    make -j${jobs}
    make -j${jobs} install DESTDIR="$destdir"

    # To print shared library dependencies
    mkdir -p "${destdir}/usr/bin"
    ln -sf /usr/lib${libSuffix}/libc.so "${destdir}/usr/bin/ldd"

    # Create dynamic linker runtime file taking -$(ARCH) as reference
    for name in "${destdir}"/lib/ld-musl-*.so.1
    do
        if test -e "$name"
        then
            ld_path="${name##*/}"		# Basename
            ld_path="${ld_path%%.*}.path"	# Get rid of .so.1
            break
        fi
    done
    if test -n "$ld_path"
    then
        mkdir -p "${destdir}/etc"
        cat << EOF > "${destdir}/etc/$ld_path"
/lib
/usr/local/lib
/usr/lib
/usr/$(cc -dumpmachine)/lib

EOF
        chmod 644 "${destdir}/etc/$ld_path"
        touch "${destdir}/etc/.graft-config"
    fi

    # Copy documentation
    mkdir -p "${destdir}${docsdir}"
    cp -p $docs "${destdir}${docsdir}"
}

