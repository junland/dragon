# This file is part of the 'dragora-installer'.
#
# Purpose: Installation of .tlz packages from series.

# Show menu

dialog --colors \
 --backtitle "\ZbInstallation mode" \
 --title "SELECT THE INSTALLATION MODE" \
 --no-cancel --menu "" 7 66 0 \
"All"     "Install packages from selected series" \
"Expert"  "Select packages from chosen series" \
 2> ${SUBTMPDIR}/return-InstallPackages

# Check menu options

case "$(cat -- ${SUBTMPDIR}/return-InstallPackages)" in
All)
    # Clean for subsequent filling
    : > ${SUBTMPDIR}/return-InstallPackages_All

    # Read selected series
    IFS= read -r REPLY < ${SUBTMPDIR}/return-ShowSeries

    for serie in $REPLY
    do
        find -- "${MEDIUM_SOURCE}"/noarch "${MEDIUM_SOURCE}"/@ARCH@ \
         -type f \( -name "*@${serie}.tlz" -a ! -name "*-pass*" \) -print | \
          sort >> ${SUBTMPDIR}/return-InstallPackages_All 2> /dev/null || true
    done
    unset -v REPLY serie

    # Proceed to install the packages from selected series

    if test -s ${SUBTMPDIR}/return-InstallPackages_All
    then
        # Set some packages at the top of the list to give priority
        ed -l -s ${SUBTMPDIR}/return-InstallPackages_All << EOF
/etc_/m0
/hierarchyfs_/m1
w
EOF
        qi install \
         --rootdir=/media/dragora-root \
         --packagedir=/usr/pkg \
         --targetdir=/ \
         --prune - < ${SUBTMPDIR}/return-InstallPackages_All
    else
        echo "${PROGRAM}: Error the package list is empty." 1>&2
        exit 99;
    fi
    ;;
Expert)
    ;;
esac

