To: vim_dev@googlegroups.com
Subject: Patch 8.0.0880
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit
------------

Patch 8.0.0880
Problem:    Travis uses an old Ubuntu version.
Solution:   Switch from precise to trusty. (Ken Takata, closes #1897)
Files:      .travis.yml, Filelist, src/testdir/if_ver-1.vim,
            src/testdir/if_ver-2.vim, src/testdir/lsan-suppress.txt


*** ../vim-8.0.0879/.travis.yml	2017-07-28 18:01:54.042023391 +0200
--- .travis.yml	2017-08-06 17:03:14.205260966 +0200
***************
*** 1,6 ****
  language: c
! # trusty still has a few problems, use precise until they are solved.
! dist: precise
  
  os:
    - osx
--- 1,5 ----
  language: c
! dist: trusty
  
  os:
    - osx
***************
*** 22,28 ****
      "CONFOPT='--enable-perlinterp --enable-pythoninterp --enable-rubyinterp --enable-luainterp'"
      # ASAN build
    - BUILD=yes TEST=test SANITIZER_CFLAGS="-g -O1 -DABORT_ON_INTERNAL_ERROR -DEXITFREE -fsanitize=address -fno-omit-frame-pointer"
!     FEATURES=huge SRCDIR=./src CHECK_AUTOCONF=no ASAN_OPTIONS="print_stacktrace=1 log_path=asan"
      "CONFOPT='--enable-perlinterp --enable-pythoninterp --enable-rubyinterp --enable-luainterp'"
  
  sudo: false
--- 21,27 ----
      "CONFOPT='--enable-perlinterp --enable-pythoninterp --enable-rubyinterp --enable-luainterp'"
      # ASAN build
    - BUILD=yes TEST=test SANITIZER_CFLAGS="-g -O1 -DABORT_ON_INTERNAL_ERROR -DEXITFREE -fsanitize=address -fno-omit-frame-pointer"
!     FEATURES=huge SRCDIR=./src CHECK_AUTOCONF=no ASAN_OPTIONS="print_stacktrace=1 log_path=asan" LSAN_OPTIONS="suppressions=$TRAVIS_BUILD_DIR/src/testdir/lsan-suppress.txt"
      "CONFOPT='--enable-perlinterp --enable-pythoninterp --enable-rubyinterp --enable-luainterp'"
  
  sudo: false
***************
*** 43,54 ****
              "CONFOPT='--enable-perlinterp --enable-pythoninterp --enable-python3interp --enable-rubyinterp --enable-luainterp'"
      - os: osx
        env: BUILD=yes TEST=test SANITIZER_CFLAGS="-g -O1 -DABORT_ON_INTERNAL_ERROR -DEXITFREE -fsanitize=address -fno-omit-frame-pointer"
!             FEATURES=huge SRCDIR=./src CHECK_AUTOCONF=no ASAN_OPTIONS="print_stacktrace=1 log_path=asan"
              "CONFOPT='--enable-perlinterp --enable-pythoninterp --enable-rubyinterp --enable-luainterp'"
      - os: linux
!       compiler: gcc
        env: BUILD=yes TEST=test SANITIZER_CFLAGS="-g -O1 -DABORT_ON_INTERNAL_ERROR -DEXITFREE -fsanitize=address -fno-omit-frame-pointer"
!             FEATURES=huge SRCDIR=./src CHECK_AUTOCONF=no ASAN_OPTIONS="print_stacktrace=1 log_path=asan"
              "CONFOPT='--enable-perlinterp --enable-pythoninterp --enable-rubyinterp --enable-luainterp'"
      - os: linux
        compiler: clang
--- 42,53 ----
              "CONFOPT='--enable-perlinterp --enable-pythoninterp --enable-python3interp --enable-rubyinterp --enable-luainterp'"
      - os: osx
        env: BUILD=yes TEST=test SANITIZER_CFLAGS="-g -O1 -DABORT_ON_INTERNAL_ERROR -DEXITFREE -fsanitize=address -fno-omit-frame-pointer"
!             FEATURES=huge SRCDIR=./src CHECK_AUTOCONF=no ASAN_OPTIONS="print_stacktrace=1 log_path=asan" LSAN_OPTIONS="suppressions=$TRAVIS_BUILD_DIR/src/testdir/lsan-suppress.txt"
              "CONFOPT='--enable-perlinterp --enable-pythoninterp --enable-rubyinterp --enable-luainterp'"
      - os: linux
!       compiler: clang
        env: BUILD=yes TEST=test SANITIZER_CFLAGS="-g -O1 -DABORT_ON_INTERNAL_ERROR -DEXITFREE -fsanitize=address -fno-omit-frame-pointer"
!             FEATURES=huge SRCDIR=./src CHECK_AUTOCONF=no ASAN_OPTIONS="print_stacktrace=1 log_path=asan" LSAN_OPTIONS="suppressions=$TRAVIS_BUILD_DIR/src/testdir/lsan-suppress.txt"
              "CONFOPT='--enable-perlinterp --enable-pythoninterp --enable-rubyinterp --enable-luainterp'"
      - os: linux
        compiler: clang
***************
*** 74,88 ****
        - python3-dev
        - liblua5.2-dev
        - lua5.2
        - cscope
  
  before_install:
!   - if [ "$COVERAGE" = "yes" ]; then pip install --user cpp-coveralls==0.3.12; fi
      # needed for https support for coveralls
      # building cffi only works with gcc, not with clang
    - if [ "$COVERAGE" = "yes" ]; then CC=gcc pip install --user pyopenssl ndg-httpsclient pyasn1; fi
      # Lua is not installed on Travis OSX
    - if [ "$TRAVIS_OS_NAME" = "osx" ]; then brew install lua; export LUA_PREFIX=/usr/local; fi
  
  # Start virtual framebuffer to be able to test the GUI. Does not work on OS X.
  before_script:
--- 73,95 ----
        - python3-dev
        - liblua5.2-dev
        - lua5.2
+       - ruby-dev
        - cscope
+       - libgtk2.0-dev
  
  before_install:
!   - rvm reset
!     # Remove /opt/python/3.x.x/bin from $PATH for using system python3.
!     # ("pyenv global system" doesn't seem to work.)
!   - if [ "$TRAVIS_OS_NAME" = "linux" ] && which python3 | grep '/opt/python/' > /dev/null; then export PATH=$(echo $PATH | sed -e "s#$(echo $(which python3) | sed -e 's#/python3$##'):##"); fi
!   - if [ "$COVERAGE" = "yes" ]; then pip install --user cpp-coveralls; fi
      # needed for https support for coveralls
      # building cffi only works with gcc, not with clang
    - if [ "$COVERAGE" = "yes" ]; then CC=gcc pip install --user pyopenssl ndg-httpsclient pyasn1; fi
      # Lua is not installed on Travis OSX
    - if [ "$TRAVIS_OS_NAME" = "osx" ]; then brew install lua; export LUA_PREFIX=/usr/local; fi
+     # Use llvm-cov instead of gcov when compiler is clang.
+   - if [ "$TRAVIS_OS_NAME" = "linux" ] && [ "$CC" = "clang" ]; then ln -sf $(which llvm-cov) /home/travis/bin/gcov; fi
  
  # Start virtual framebuffer to be able to test the GUI. Does not work on OS X.
  before_script:
***************
*** 93,99 ****
    - if [ "$CHECK_AUTOCONF" = "yes" -a "$CC" = "gcc" ]; then make -C src autoconf; fi
    - if [ "x$SHADOWOPT" != x ]; then make -C src shadow; fi
    - (cd ${SRCDIR} && ./configure --with-features=$FEATURES $CONFOPT --enable-fail-if-missing && if [ "$BUILD" = "yes" ]; then make -j$NPROC; fi)
!   - if [ "$BUILD" = "yes" ]; then ${SRCDIR}/vim --version; fi
    - if [ -n "$ASAN_OPTIONS" ]; then export PATH=/usr/lib/llvm-$(clang -v 2>&1 | sed -n 's/.*version \([1-9]\.[0-9][0-9]*\).*/\1/p')/bin:$PATH; fi
    - make $SHADOWOPT $TEST
    - if [ -n "$ASAN_OPTIONS" ]; then for log in $(find -type f -name 'asan.*' -size +0); do cat "$log"; err=1; done; fi
--- 100,107 ----
    - if [ "$CHECK_AUTOCONF" = "yes" -a "$CC" = "gcc" ]; then make -C src autoconf; fi
    - if [ "x$SHADOWOPT" != x ]; then make -C src shadow; fi
    - (cd ${SRCDIR} && ./configure --with-features=$FEATURES $CONFOPT --enable-fail-if-missing && if [ "$BUILD" = "yes" ]; then make -j$NPROC; fi)
!     # Show Vim version and also if_xx versions.
!   - if [ "$BUILD" = "yes" ]; then ${SRCDIR}/vim --version; ${SRCDIR}/vim --not-a-term -u NONE -S ${SRCDIR}/testdir/if_ver-1.vim -c quit > /dev/null; ${SRCDIR}/vim --not-a-term -u NONE -S ${SRCDIR}/testdir/if_ver-2.vim -c quit > /dev/null; cat if_ver.txt; fi
    - if [ -n "$ASAN_OPTIONS" ]; then export PATH=/usr/lib/llvm-$(clang -v 2>&1 | sed -n 's/.*version \([1-9]\.[0-9][0-9]*\).*/\1/p')/bin:$PATH; fi
    - make $SHADOWOPT $TEST
    - if [ -n "$ASAN_OPTIONS" ]; then for log in $(find -type f -name 'asan.*' -size +0); do cat "$log"; err=1; done; fi
*** ../vim-8.0.0879/Filelist	2017-07-30 16:58:52.762976876 +0200
--- Filelist	2017-08-06 17:03:14.209260937 +0200
***************
*** 134,139 ****
--- 134,140 ----
  		src/testdir/bench*.in \
  		src/testdir/bench*.vim \
  		src/testdir/samples/*.txt \
+ 		src/testdir/if_ver*.vim \
  		src/proto.h \
  		src/proto/arabic.pro \
  		src/proto/blowfish.pro \
*** ../vim-8.0.0879/src/testdir/if_ver-1.vim	2017-08-06 17:05:18.196354256 +0200
--- src/testdir/if_ver-1.vim	2017-08-06 17:03:14.209260937 +0200
***************
*** 0 ****
--- 1,26 ----
+ " Print all interface versions and write the result into if_ver.txt.
+ " For Ubuntu. Part 1.
+ 
+ redir! > if_ver.txt
+ if 1
+   echo "*** Interface versions ***"
+   echo "\nLua:"
+   lua print(_VERSION)
+   " echo "\nLuaJIT:"
+   " lua print(jit.version)
+   if has('mzscheme')
+     echo "\nMzScheme:"
+     mzscheme (display (version))
+   endif
+   echo "\nPerl:"
+   perl print $^V
+   echo "\nRuby:"
+   ruby print RUBY_VERSION
+   if has('tcl')
+     echo "\nTcl:"
+     tcl puts [info patchlevel]
+   endif
+   echo "\nPython 2:"
+   python import sys; print sys.version
+ endif
+ redir END
*** ../vim-8.0.0879/src/testdir/if_ver-2.vim	2017-08-06 17:05:18.204354198 +0200
--- src/testdir/if_ver-2.vim	2017-08-06 17:03:14.209260937 +0200
***************
*** 0 ****
--- 1,10 ----
+ " Print py3 interface version and write the result into if_ver.txt.
+ " For Ubuntu. Part 2.
+ 
+ redir! >> if_ver.txt
+ if 1
+   echo "\nPython 3:"
+   python3 import sys; print(sys.version)
+   echo "\n"
+ endif
+ redir END
*** ../vim-8.0.0879/src/testdir/lsan-suppress.txt	2017-08-06 17:05:18.208354168 +0200
--- src/testdir/lsan-suppress.txt	2017-08-06 17:03:14.209260937 +0200
***************
*** 0 ****
--- 1,3 ----
+ # Suppress leaks from X libraries on Ubuntu trusty.
+ leak:libX11.so.6
+ leak:libXt.so.6
*** ../vim-8.0.0879/src/version.c	2017-08-06 15:42:01.640570872 +0200
--- src/version.c	2017-08-06 17:04:34.480673912 +0200
***************
*** 771,772 ****
--- 771,774 ----
  {   /* Add new patch number below this line */
+ /**/
+     880,
  /**/

-- 
The Law of VIM:
For each member b of the possible behaviour space B of program P, there exists
a finite time t before which at least one user u in the total user space U of
program P will request b becomes a member of the allowed behaviour space B'
(B' <= B).
In other words: Sooner or later everyone wants everything as an option.
                                        -- Vince Negri

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\  an exciting new programming language -- http://www.Zimbu.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
