To: vim_dev@googlegroups.com
Subject: Patch 8.0.0750
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
Mime-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit
------------

Patch 8.0.0750
Problem:    OpenPTY missing in non-GUI build.
Solution:   Always include pty.c, add an #ifdef to skip over the contents.
Files:      src/pty.c, src/Makefile


*** ../vim-8.0.0749/src/pty.c	2016-12-03 16:40:44.432532400 +0100
--- src/pty.c	2017-07-22 20:48:14.082837896 +0200
***************
*** 43,48 ****
--- 43,50 ----
  
  #include "vim.h"
  
+ #if defined(FEAT_GUI) || defined(FEAT_TERMINAL)
+ 
  #include <signal.h>
  
  #ifdef __CYGWIN32__
***************
*** 414,416 ****
--- 416,420 ----
      return -1;
  }
  #endif
+ 
+ #endif /* FEAT_GUI || FEAT_TERMINAL */
*** ../vim-8.0.0749/src/Makefile	2017-07-19 18:18:27.824135688 +0200
--- src/Makefile	2017-07-22 20:51:55.241248694 +0200
***************
*** 1249,1258 ****
  NONE_INSTALL = install_normal
  
  ### GTK GUI
! GTK_SRC		= gui.c gui_gtk.c gui_gtk_x11.c pty.c gui_gtk_f.c \
  			gui_beval.c $(GRESOURCE_SRC)
  GTK_OBJ		= objects/gui.o objects/gui_gtk.o objects/gui_gtk_x11.o \
! 			objects/pty.o objects/gui_gtk_f.o \
  			objects/gui_beval.o $(GRESOURCE_OBJ)
  GTK_DEFS	= -DFEAT_GUI_GTK $(NARROW_PROTO)
  GTK_IPATH	= $(GUI_INC_LOC)
--- 1249,1258 ----
  NONE_INSTALL = install_normal
  
  ### GTK GUI
! GTK_SRC		= gui.c gui_gtk.c gui_gtk_x11.c gui_gtk_f.c \
  			gui_beval.c $(GRESOURCE_SRC)
  GTK_OBJ		= objects/gui.o objects/gui_gtk.o objects/gui_gtk_x11.o \
! 			objects/gui_gtk_f.o \
  			objects/gui_beval.o $(GRESOURCE_OBJ)
  GTK_DEFS	= -DFEAT_GUI_GTK $(NARROW_PROTO)
  GTK_IPATH	= $(GUI_INC_LOC)
***************
*** 1266,1275 ****
  GTK_BUNDLE	=
  
  ### Motif GUI
! MOTIF_SRC	= gui.c gui_motif.c gui_x11.c pty.c gui_beval.c \
  			gui_xmdlg.c gui_xmebw.c
  MOTIF_OBJ	= objects/gui.o objects/gui_motif.o objects/gui_x11.o \
! 			objects/pty.o objects/gui_beval.o \
  			objects/gui_xmdlg.o objects/gui_xmebw.o
  MOTIF_DEFS	= -DFEAT_GUI_MOTIF $(NARROW_PROTO)
  MOTIF_IPATH	= $(GUI_INC_LOC)
--- 1266,1275 ----
  GTK_BUNDLE	=
  
  ### Motif GUI
! MOTIF_SRC	= gui.c gui_motif.c gui_x11.c gui_beval.c \
  			gui_xmdlg.c gui_xmebw.c
  MOTIF_OBJ	= objects/gui.o objects/gui_motif.o objects/gui_x11.o \
! 			objects/gui_beval.o \
  			objects/gui_xmdlg.o objects/gui_xmebw.o
  MOTIF_DEFS	= -DFEAT_GUI_MOTIF $(NARROW_PROTO)
  MOTIF_IPATH	= $(GUI_INC_LOC)
***************
*** 1289,1304 ****
  
  ### When using Xaw3d, uncomment/comment the following lines to also get the
  ### scrollbars from Xaw3d.
! #ATHENA_SRC	= gui.c gui_athena.c gui_x11.c pty.c gui_beval.c gui_at_fs.c
  #ATHENA_OBJ	= objects/gui.o objects/gui_athena.o objects/gui_x11.o \
! #			objects/pty.o objects/gui_beval.o objects/gui_at_fs.o
  #ATHENA_DEFS	= -DFEAT_GUI_ATHENA $(NARROW_PROTO) \
  #		    -Dvim_scrollbarWidgetClass=scrollbarWidgetClass \
  #		    -Dvim_XawScrollbarSetThumb=XawScrollbarSetThumb
! ATHENA_SRC	= gui.c gui_athena.c gui_x11.c pty.c gui_beval.c \
  			gui_at_sb.c gui_at_fs.c
  ATHENA_OBJ	= objects/gui.o objects/gui_athena.o objects/gui_x11.o \
! 			objects/pty.o objects/gui_beval.o \
  			objects/gui_at_sb.o objects/gui_at_fs.o
  ATHENA_DEFS	= -DFEAT_GUI_ATHENA $(NARROW_PROTO)
  
--- 1289,1304 ----
  
  ### When using Xaw3d, uncomment/comment the following lines to also get the
  ### scrollbars from Xaw3d.
! #ATHENA_SRC	= gui.c gui_athena.c gui_x11.c gui_beval.c gui_at_fs.c
  #ATHENA_OBJ	= objects/gui.o objects/gui_athena.o objects/gui_x11.o \
! #			objects/gui_beval.o objects/gui_at_fs.o
  #ATHENA_DEFS	= -DFEAT_GUI_ATHENA $(NARROW_PROTO) \
  #		    -Dvim_scrollbarWidgetClass=scrollbarWidgetClass \
  #		    -Dvim_XawScrollbarSetThumb=XawScrollbarSetThumb
! ATHENA_SRC	= gui.c gui_athena.c gui_x11.c gui_beval.c \
  			gui_at_sb.c gui_at_fs.c
  ATHENA_OBJ	= objects/gui.o objects/gui_athena.o objects/gui_x11.o \
! 			objects/gui_beval.o \
  			objects/gui_at_sb.o objects/gui_at_fs.o
  ATHENA_DEFS	= -DFEAT_GUI_ATHENA $(NARROW_PROTO)
  
***************
*** 1315,1323 ****
  ### neXtaw GUI
  NEXTAW_LIB = -lneXtaw
  
! NEXTAW_SRC	= gui.c gui_athena.c gui_x11.c pty.c gui_beval.c gui_at_fs.c
  NEXTAW_OBJ	= objects/gui.o objects/gui_athena.o objects/gui_x11.o \
! 			objects/pty.o objects/gui_beval.o objects/gui_at_fs.o
  NEXTAW_DEFS	= -DFEAT_GUI_ATHENA -DFEAT_GUI_NEXTAW $(NARROW_PROTO)
  
  NEXTAW_IPATH	= $(GUI_INC_LOC)
--- 1315,1323 ----
  ### neXtaw GUI
  NEXTAW_LIB = -lneXtaw
  
! NEXTAW_SRC	= gui.c gui_athena.c gui_x11.c gui_beval.c gui_at_fs.c
  NEXTAW_OBJ	= objects/gui.o objects/gui_athena.o objects/gui_x11.o \
! 			objects/gui_beval.o objects/gui_at_fs.o
  NEXTAW_DEFS	= -DFEAT_GUI_ATHENA -DFEAT_GUI_NEXTAW $(NARROW_PROTO)
  
  NEXTAW_IPATH	= $(GUI_INC_LOC)
***************
*** 1342,1349 ****
  #EXTRA_LIBS = /usr/openwin/lib/libXmu.sa -lm
  
  # PHOTON GUI
! PHOTONGUI_SRC	= gui.c gui_photon.c pty.c
! PHOTONGUI_OBJ	= objects/gui.o objects/gui_photon.o objects/pty.o
  PHOTONGUI_DEFS	= -DFEAT_GUI_PHOTON
  PHOTONGUI_IPATH	=
  PHOTONGUI_LIBS_DIR =
--- 1342,1349 ----
  #EXTRA_LIBS = /usr/openwin/lib/libXmu.sa -lm
  
  # PHOTON GUI
! PHOTONGUI_SRC	= gui.c gui_photon.c
! PHOTONGUI_OBJ	= objects/gui.o objects/gui_photon.o
  PHOTONGUI_DEFS	= -DFEAT_GUI_PHOTON
  PHOTONGUI_IPATH	=
  PHOTONGUI_LIBS_DIR =
***************
*** 1357,1363 ****
  
  # CARBON GUI
  CARBONGUI_SRC	= gui.c gui_mac.c
! CARBONGUI_OBJ	= objects/gui.o objects/gui_mac.o objects/pty.o
  CARBONGUI_DEFS	= -DFEAT_GUI_MAC -fno-common -fpascal-strings \
  		  -Wall -Wno-unknown-pragmas \
  		  -mdynamic-no-pic -pipe
--- 1357,1363 ----
  
  # CARBON GUI
  CARBONGUI_SRC	= gui.c gui_mac.c
! CARBONGUI_OBJ	= objects/gui.o objects/gui_mac.o
  CARBONGUI_DEFS	= -DFEAT_GUI_MAC -fno-common -fpascal-strings \
  		  -Wall -Wno-unknown-pragmas \
  		  -mdynamic-no-pic -pipe
***************
*** 1374,1380 ****
  CARBONGUI_TESTARG = VIMPROG=../$(APPDIR)/Contents/MacOS/$(VIMTARGET)
  
  # All GUI files
! ALL_GUI_SRC  = gui.c gui_gtk.c gui_gtk_f.c gui_motif.c gui_xmdlg.c gui_xmebw.c gui_athena.c gui_gtk_x11.c gui_x11.c gui_at_sb.c gui_at_fs.c pty.c
  ALL_GUI_PRO  = gui.pro gui_gtk.pro gui_motif.pro gui_xmdlg.pro gui_athena.pro gui_gtk_x11.pro gui_x11.pro gui_w32.pro gui_photon.pro
  
  # }}}
--- 1374,1380 ----
  CARBONGUI_TESTARG = VIMPROG=../$(APPDIR)/Contents/MacOS/$(VIMTARGET)
  
  # All GUI files
! ALL_GUI_SRC  = gui.c gui_gtk.c gui_gtk_f.c gui_motif.c gui_xmdlg.c gui_xmebw.c gui_athena.c gui_gtk_x11.c gui_x11.c gui_at_sb.c gui_at_fs.c
  ALL_GUI_PRO  = gui.pro gui_gtk.pro gui_motif.pro gui_xmdlg.pro gui_athena.pro gui_gtk_x11.pro gui_x11.pro gui_w32.pro gui_photon.pro
  
  # }}}
***************
*** 1565,1570 ****
--- 1565,1571 ----
  	os_unix.c \
  	auto/pathdef.c \
  	popupmnu.c \
+ 	pty.c \
  	quickfix.c \
  	regexp.c \
  	screen.c \
***************
*** 1672,1677 ****
--- 1673,1679 ----
  	objects/os_unix.o \
  	objects/pathdef.o \
  	objects/popupmnu.o \
+ 	objects/pty.o \
  	objects/quickfix.o \
  	objects/regexp.o \
  	objects/screen.o \
***************
*** 3218,3229 ****
  objects/pathdef.o: auto/pathdef.c
  	$(CCC) -o $@ auto/pathdef.c
  
- objects/pty.o: pty.c
- 	$(CCC) -o $@ pty.c
- 
  objects/popupmnu.o: popupmnu.c
  	$(CCC) -o $@ popupmnu.c
  
  objects/quickfix.o: quickfix.c
  	$(CCC) -o $@ quickfix.c
  
--- 3220,3231 ----
  objects/pathdef.o: auto/pathdef.c
  	$(CCC) -o $@ auto/pathdef.c
  
  objects/popupmnu.o: popupmnu.c
  	$(CCC) -o $@ popupmnu.c
  
+ objects/pty.o: pty.c
+ 	$(CCC) -o $@ pty.c
+ 
  objects/quickfix.o: quickfix.c
  	$(CCC) -o $@ quickfix.c
  
*** ../vim-8.0.0749/src/version.c	2017-07-22 20:41:59.573529015 +0200
--- src/version.c	2017-07-22 20:52:21.577059449 +0200
***************
*** 771,772 ****
--- 771,774 ----
  {   /* Add new patch number below this line */
+ /**/
+     750,
  /**/

-- 
hundred-and-one symptoms of being an internet addict:
210. When you get a divorce, you don't care about who gets the children,
     but discuss endlessly who can use the email address.

 /// Bram Moolenaar -- Bram@Moolenaar.net -- http://www.Moolenaar.net   \\\
///        sponsor Vim, vote for features -- http://www.Vim.org/sponsor/ \\\
\\\  an exciting new programming language -- http://www.Zimbu.org        ///
 \\\            help me help AIDS victims -- http://ICCF-Holland.org    ///
