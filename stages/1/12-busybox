# Build script for busybox
#
# Copyright (C) 2014-2017 Matias Fonzo, <selk@dragora.org>
#
# This script is free software: you have unlimited permission
# to copy, distribute and modify it.

version=1.27.2

rm -rf -- "${TMPDIR}/busybox-${version}"
untar "${worktree}/sources/busybox-${version}.tar.bz2" "$TMPDIR"

# Build instructions
cd -- "$TMPDIR"
cd "busybox-${version}" || cd busybox;

# Import and export toolchain variables
. "${worktree}/stages/env.d/cross-staticenv"

# Patch including lzip support
patch -Np1 -i "${worktree}/patches/busybox/busybox-1.27.0_lzip-0.patch"

make mrproper
cat "${worktree}/archive/busybox/busybox-config_stage1" > .config

make -j${jobs} busybox V=1 \
  ARCH="$kernel_arch" \
  CROSS_COMPILE="${target}-"

make install CONFIG_PREFIX=/tools \
  ARCH="$kernel_arch" \
  CROSS_COMPILE="${target}-"

# Unset some imported variables from file
unset AR AS LD RANLIB READELF STRIP

cleanup()
{
    cd -- "$TMPDIR" && rm -rf busybox-*
}

