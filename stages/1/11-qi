# Build script for qi
#
# Copyright (C) 2015-2017 Matias Fonzo, <selk@dragora.org>
#
# This script is free software: you have unlimited permission
# to copy, distribute and modify it.

echo "Making Qi from ${CWD}/qi ..."

cd -- "${CWD}/qi"

make clean

./configure --prefix=/tools

make
make install

# Clean up the source repository
rm -f config.mak
make clean

# Copy our custom qirc to /tools
cp -p "${worktree}/archive/qi/qirc" /tools/etc/
chmod 644 /tools/etc/qirc

# Set compiler options provided by default in Dragora
case $arch in
i586)
    sed -i \
     -e 's|#QICFLAGS=.*|QICFLAGS=-g0 -Os -march=i586 -mtune=i686|' \
     -e 's|#QICXXFLAGS=.*|QICXXFLAGS=-g0 -Os -march=i586 -mtune=i686|' \
     /tools/etc/qirc
    ;;
x86_64)
    sed -i \
     -e 's|#QICFLAGS=.*|QICFLAGS=-g0 -Os -mtune=generic|' \
     -e 's|#QICXXFLAGS=.*|QICXXFLAGS=-g0 -Os -mtune=generic|' \
     /tools/etc/qirc
    ;;
esac

# Include additional settings from targets/

# We prefix '--enable-multilib' for targets supporting it,
# the native GCC wants this option explicitly
if test -n "$multilib_options"
then
    case $multilib_options in
    *--disable-multilib* | *--enable-multilib*)
        true
        ;;
    *)
        multilib_options="--enable-multilib $multilib_options"
        ;;
    esac
fi

cat << EOF >> /tools/etc/qirc

# Multilib options
multilib_options=$multilib_options

# lib<equal> suffix (multilib, if any)
libSuffix=$libSuffix

# GCC (arch-specific) options
gcc_options=$gcc_options
EOF

