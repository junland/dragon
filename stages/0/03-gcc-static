# Build script for gcc.
#
# Copyright (c) 2016-2018 Matias Fonzo, <selk@dragora.org>.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

version=7-20180628

# Prerequisites
gmp_version=6.1.2
mpfr_version=4.0.1
mpc_version=1.1.0
isl_version=0.19

cd -- "$TMPDIR"

rm -rf gcc-${version} gmp-${gmp_version} \
       mpfr-${mpfr_version} mpc-${mpc_version} isl-${isl_version}
unpack "${worktree}/sources/gcc-${version}.tar.xz" \
       "${worktree}/sources/gmp-${gmp_version}.tar.lz" \
       "${worktree}/sources/mpfr-${mpfr_version}.tar.bz2" \
       "${worktree}/sources/mpc-${mpc_version}.tar.gz" \
       "${worktree}/sources/isl-${isl_version}.tar.bz2"

# Build instructions
cd gcc-${version}

# Make symlinks for requisites
ln -s ../gmp-${gmp_version} gmp
ln -s ../mpfr-${mpfr_version} mpfr
ln -s ../mpc-${mpc_version} mpc
ln -s ../isl-${isl_version} isl

# Apply patches for MPFR
(
    cd mpfr || exit 1

    for file in "${worktree}"/patches/mpfr/*
    do
        if test -f "$file"
        then
            rm -f PATCHES
            patch -p1 < "$file"
        fi
    done
)

# Apply specific patches for the support in musl.
# http://port70.net/~nsz/musl/gcc-7.3.0

patch -Np1 -i "${worktree}/patches/gcc/0001-ssp_nonshared.diff"
patch -Np1 -i "${worktree}/patches/gcc/0002-posix_memalign.diff"
patch -Np1 -i "${worktree}/patches/gcc/0003-cilkrts.diff"
patch -Np1 -i "${worktree}/patches/gcc/0004-libatomic-test-fix.diff"
patch -Np1 -i "${worktree}/patches/gcc/0005-libgomp-test-fix.diff"
patch -Np1 -i "${worktree}/patches/gcc/0006-libitm-test-fix.diff"
patch -Np1 -i "${worktree}/patches/gcc/0007-libvtv-test-fix.diff"
patch -Np1 -i "${worktree}/patches/gcc/0008-static-pie-support.diff"
patch -Np1 -i "${worktree}/patches/gcc/0009-j2.diff"
patch -Np1 -i "${worktree}/patches/gcc/0010-s390x-muslldso.diff"
patch -Np1 -i "${worktree}/patches/gcc/0011-microblaze-pr65649.diff"
patch -Np1 -i "${worktree}/patches/gcc/0012-ldbl128-config.diff"

# Build in a separate directory
rm -rf ../gcc-build
mkdir ../gcc-build
cd ../gcc-build

../gcc-${version}/configure \
AR="ar" CC="$BTCC" CXX="$BTCXX" \
CFLAGS="$BTCFLAGS" CXXFLAGS="$BTCXXFLAGS" LDFLAGS="$BTLDFLAGS" \
 --prefix="$crossdir" \
 --libdir="${crossdir}/lib${libSuffix}" \
 --build=$host \
 --host=$host \
 --target=$target \
 --enable-languages=c \
 --enable-clocale=generic \
 --disable-shared \
 --disable-threads \
 --disable-decimal-float \
 --disable-libgomp \
 --disable-libssp \
 --disable-libatomic \
 --disable-libitm \
 --disable-libquadmath \
 --disable-libvtv \
 --disable-libcilkrts \
 --disable-libstdcxx \
 --disable-gnu-indirect-function \
 --disable-libmudflap \
 --disable-libsanitizer \
 --disable-libmpx \
 --disable-nls \
 --with-sysroot="${crossdir}/$target" \
 --with-newlib \
 --without-headers \
 --without-ppl \
 --without-cloog \
 $multilib_options \
 $gcc_options

make -j${jobs} all-gcc all-target-libgcc
make -j${jobs} install-gcc install-target-libgcc

cleanup()
{
    cd -- "$TMPDIR" && rm -rf gcc-${version} \
     gmp-${gmp_version} mpfr-${mpfr_version} \
     mpc-${mpc_version} isl-${isl_version}
}

